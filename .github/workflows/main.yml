name: Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Checks
      uses: pre-commit/action@v3.0.1

  mkl:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install
      id: install
      uses: ./
      with:
        components: mkl
    - name: Build/run
      run: |
        # should not need to source setvars.sh
        # try again for 2024.1
        source ${{ steps.install.outputs.root }}/setvars.sh
        cmake -B build -DENABLE_MKL=on test
        make -C build all test

  compilers:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install
      uses: ./
      id: install
      with:
        components: |
          icx
          ifx
          impi
    - name: Build/run
      run: |
        source ${{ steps.install.outputs.root }}/setvars.sh
        CC=icx CXX=icpx FC=ifx cmake -B build -DENABLE_COMPILERS=on test
        make -C build all test
    - name: Test mpi
      run: |
        source ${{ steps.install.outputs.root }}/setvars.sh
        cd test/compilers
        mkdir build
        ./mpi-test.sh

  dal:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install
      uses: ./
      id: install
      with:
        components: dal
    - name: Test
      run: source ${{ steps.install.outputs.root }}/setvars.sh

  ipp:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install
      uses: ./
      id: install
      with:
        components: ipp
    - name: Test
      run: source ${{ steps.install.outputs.root }}/setvars.sh

  rest:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install
      uses: ./
      id: install
      with:
        components: |
          ccl
          dnn
          dpl
          ippcp
          tbb
    - name: Test
      run: source ${{ steps.install.outputs.root }}/setvars.sh
